@page "/orders"
@using BanSach.Components.Services.OrderService
@inject IOrderService OrderService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager 
@using System.Security.Claims
<PageTitle>Hóa Đơn</PageTitle>

<MudPaper Elevation="4" Class="pa-4">
    <MudText Typo="Typo.h5" Class="mb-3">Danh sách hóa đơn của bạn</MudText>

    @if (orders == null)
    {
        <MudProgressCircular Indeterminate="true" Size="Size.Large" />
    }
    else if (orders.Count == 0)
    {
        <MudText>Không có hóa đơn nào.</MudText>
    }
    else
    {
        <MudTable Items="orders" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Id Hóa Đơn</MudTh>
                <MudTh>Ngày Tạo</MudTh>
                <MudTh>Trạng Thái</MudTh>
                <MudTh>Tổng Tiền</MudTh>
                <MudTh>Chi Tiết</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Id Hóa Đơn">@context.BillId</MudTd>
                <MudTd DataLabel="Ngày Tạo">@context.Created_at?.ToString("dd/MM/yyyy")</MudTd>
                <MudTd DataLabel="Trạng Thái">@context.Status</MudTd>
                <MudTd DataLabel="Tổng Tiền">@context.TotalPrice.ToString("C")</MudTd>
                <MudTd DataLabel="Chi Tiết">
                    <MudButton Color="Color.Primary" @onclick="() => ViewOrderDetail(context.BillId)">
                        Xem
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private List<Bill> orders;

    protected override async Task OnInitializedAsync()
    {
        // Lấy thông tin người dùng từ AuthenticationState
        var user = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        if (user.Identity.IsAuthenticated)
        {
            var userId = int.Parse(user.FindFirstValue(ClaimTypes.NameIdentifier)); // Lấy UserId từ Claims
            orders = await OrderService.GetOrdersByUserIdAsync(userId);
        }
    }

    private void ViewOrderDetail(int billId)
    {
        // Điều hướng đến trang chi tiết hóa đơn
        NavigationManager.NavigateTo($"/order/{billId}");
    }
}
